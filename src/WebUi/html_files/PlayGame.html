<!DOCTYPE unspecified PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<head>
    <head>
        <script>
            history.forward();
        </script>
    </head>
    <style type="text/css">
        #pgnBox {
            background-color: white;
            width: 20%;
            border: 2px solid white;
            overflow: auto;
            float: left;
        }
        #showPgn {
            background-color: white;
            width: 80%;
            height: 475px;
            border: 2px solid black;
            padding: 15px;
            overflow: auto;
        }
        #GameBox {
            padding-top: 30px;
            border: 1px solid white;
            width: 510px;
            float: left;
        }

        .button {
            padding-top: 50px;
            padding-right: 50px;
            width: 50px;
        }

        .bot {
            margin-left: 20px;
            padding: 5px;
            width: 280px;
        }

        th {
            border: 30px solid white;
            height: 100px;
        }
    </style>
    <!-- Order of inclusion : Library -> Utilities -> Pieces -> Controls -->

    <script type="text/javascript" src="../clientlib/jquery.min-3.5.js"></script>
    <script type="text/javascript" src="../clientlib/jquery-ui.min.js"></script>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
          integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <script type="text/javascript">
        statusCalled = false;
        var logid;
        var log;
        var uniqueId;
        var x = window.location.origin;
        $.ajax({
            url: x + "/getUserId",
            type: 'POST',
            success: function (response) {
                if (response.user_id === 'null') {
                    alert(' Login First !');
                    location = '/loginpage';
                }
                console.log('difficulty ajax success!!');
            }
        });

        window.onload = (event) => {
            var url=location.href;
            logid=url.split('=')[2];
            uniqueId=url.split('=')[1].split('&')[0];
            log=url.split('=')[1].split('&')[1];
            console.log("uniqueId "+uniqueId)
            console.log("log "+log)
            console.log("logid " + logid)
            startNew();
        };
    </script>
</head>
<body>
<div id="GameBox">
    <div id="myBoard" style="width: 500px"></div>
</div>
<div id="pgnBox">
    <div><p id="showPgn" style="font-size: 20px;">PGN:</p></div>
    <button onclick="saveTextAsFile()">Save Pgn to File</button>

</div>
<div class="bot">
    <table>
        <tr>
            <th><input type="button" onclick="nextMove()" value="Next Step" cellpadding="0" cellspacing="0"/></th>
            <th><input type="button" onclick="prevStep()" value="Previous Step" cellpadding="0" cellspacing="0"/></th>
            <th><input type="button" onclick="startNew();window.location.reload();" value="Start Again" cellpadding="0"
                       cellspacing="0"/></th>
        </tr>
    </table>
</div>
<div class="bot">
    <form action="/homepage" method="post" align="center">
        <input style="margin-left: 150px" type="submit" value="Go Back to Home Page"/>
    </form>
</div>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"
        integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz"
        crossorigin="anonymous"></script>
<script type="text/javascript">
    var step = 0;
    var nextCalled = false;
    var prevMoveCalled = false;
    var alertStatus = null;
    var $pgn = $('#showPgn')
    var game = new Chess()
    animation_moved = true;
    var checkStatus;

    function onMoveEnd(oldPos, newPos) {
        if (alertStatus != null) {
            alert(alertStatus);
            alertStatus = null;
        }
        $pgn.html("PGN: " + game.pgn())
        animation_moved = true;
    }

    var config = {
        position: 'start',
        onMoveEnd: onMoveEnd
    }
    var board = Chessboard('myBoard', config)


    function nextMove() {
        var x = window.location.origin;
        if (statusCalled === false && animation_moved === true) {
            // var status;
            if (prevMoveCalled) {
                prevMoveCalled = false;
            } else {
                step++;
            }
            $.ajax({
                url: x + "/nextMove",
                type: 'POST',
                data: {"step": step,"log":log,"logid":logid,"uniqueId":uniqueId},
                success: function (response) {
                    //step = response.step;
                    checkStatus=response.checkStatus ;
                    if (checkStatus=== "Draw") {
                        alertStatus = "Match Draw!";
                        statusCalled = true;
                    } else if (checkStatus === "Player1") {
                        alertStatus = "Player 1 Wins (White)!";
                        statusCalled = true;
                    } else if (checkStatus === "Player2") {
                        alertStatus = "Player 2 Wins (Black)!";
                        statusCalled = true;
                    }
                    animation_moved = false;
                    var pgnMove = response.pgn;
                    game.move(pgnMove)
                    board.position(game.fen())
                }
            });
            nextCalled = true;

        }

    }

    function saveTextAsFile()
    {
        var result='';
        if(statusCalled===true){
            if(checkStatus==='Player1'){
                result=' 1-0';
            }
            else if(checkStatus==='Player2'){
                result=' 0-1';
            }
            else if(checkStatus==='Draw'){
                result=' 1/2-1/2';
            }
        }
        var pgn=game.pgn();
        var textToSave = pgn+result;
        var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
        var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
        var fileNameToSaveAs = logid+'.pgn';
        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        downloadLink.href = textToSaveAsURL;
        downloadLink.onclick = destroyClickedElement;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
    }
    function destroyClickedElement(event)
    {
        document.body.removeChild(event.target);
    }

    function prevStep() {


        if (step > 0 && animation_moved === true) {
            if (!nextCalled) {
                if (step > 1) {
                    step--;
                    animation_moved = false;
                }
            }

            // var x = window.location.origin;
            // $.ajax({
            //     url: x + "/previous_step",
            //     type: 'POST',
            //     success: function (response) {

            statusCalled = false;
            game.undo()
            board.position(game.fen())
            //     }
            //
            // });
            nextCalled = false;
            prevMoveCalled = true;

        }
    }

    function startNew() {
        step = 0;
        statusCalled = false;
    }
</script>
</body>
</html>
 