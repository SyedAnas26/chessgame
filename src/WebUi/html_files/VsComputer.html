<!doctype html>
<html>
<head>
    <style type="text/css">
        #black_promotion_pieces {
            visibility: hidden;
        }

        #white_promotion_pieces {
            visibility: hidden;
        }

        #pgnBox {
            background-color: white;
            width: 20%;
            height: 580px;
            border: 2px solid white;
            padding-top: 45px;
            overflow: auto;
            float: left;
        }

        #showPgn {
            background-color: white;
            width: 80%;
            height: 475px;
            border: 2px solid black;
            padding: 15px;
            overflow: auto;
        }

        #GameBox {
            border: 1px solid white;
            width: 510px;
            height: 670px;
            float: left;
        }

        #timerBox {
            background-color: white;
            width: 20%;
            height: 305px;
            border: 2px solid white;
            padding-top: 300px;
            overflow: auto;
        }

        #time {
            width: 120px;
            height: 120px;
            background-color: #303B3B;
            padding: 20px;
            font-size: 40px;
            color: #EEF9F9;
            border: 3px solid #5DE1A4;
        }
    </style>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
          integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <script type="text/javascript" src="../clientlib/jquery.min-3.5.js"></script>
    <script type="text/javascript" src="../clientlib/jquery-ui.min.js"></script>
    <script type="text/javascript">
        var statusCalled = false;
        var alterStatus=null;
        var c = 0;
        var timer = 0;
        var t;
        var timer_is_on = 0;
        var x = window.location.origin;
        var position_to = '';
        var position_from = '';
        var difficulty;
        var gameId;
        var winner;
        window.onload=function () {
            var url=location.href;
            difficulty=url.split('=')[3];
            gameId=url.split('=')[2];
            gameId=gameId.split('&')[0];
            console.log("gameId"+gameId)
        }

        $.ajax({
            url: x + "/getUserId",
            type: 'POST',
            success: function (response) {
                if (response.user_id === 'null') {
                    alert(' Login First !');
                    location = '/loginpage';
                }
                console.log('difficulty ajax success!!');
            }
        });


        function timedCount() {
            timer = c;
            c = c + 10;
            t = setTimeout(timedCount, 10);
        }

        function startCount() {
            if (!timer_is_on) {
                timer_is_on = 1;
                timedCount()
            }
        }

        function stopCount() {
            clearTimeout(t);
            timer_is_on = 0;
            c = 0;
        }
    </script>
</head>
<body>
<div id="GameBox">
    <div id="white_promotion_pieces" style="padding-left: 50px;">
        <img src="img/chesspieces/wikipedia/wQ.png" id="wqueen" data-piece="wQ" style="width:62px;height:62px;"
             onclick="promotePiece('Q')">
        <img src="img/chesspieces/wikipedia/wN.png" id="wknight" data-piece="wN" style="width:62px;height:62px;"
             onclick="promotePiece('N')">
        <img src="img/chesspieces/wikipedia/wB.png" id="wbishop" data-piece="wB" style="width:62px;height:62px;"
             onclick="promotePiece('B')">
        <img src="img/chesspieces/wikipedia/wR.png" id="wrook" data-piece="wR" style="width:62px;height:62px;"
             onclick="promotePiece('R')">
    </div>
    <div id="myBoard" style="width: 500px">
    </div>
    <div id="black_promotion_pieces" style="padding-left: 50px;">
        <img src="img/chesspieces/wikipedia/bQ.png" id="bqueen" data-piece="bQ" style="width:62px;height:62px;"
             onclick="promotePiece('Q')">
        <img src="img/chesspieces/wikipedia/bN.png" id="bknight" data-piece="bN" style="width:62px;height:62px;"
             onclick="promotePiece('N')">
        <img src="img/chesspieces/wikipedia/bB.png" id="bbishop" data-piece="bB" style="width:62px;height:62px;"
             onclick="promotePiece('B')">
        <img src="img/chesspieces/wikipedia/bR.png" id="brook" data-piece="bR" style="width:62px;height:62px;"
             onclick="promotePiece('R')">
    </div>
    <input type="button"  style="margin-left: 205px" onclick="statusUpdate('3')" value="Claim Draw" cellpadding="0" cellspacing="0"/>
</div>
<div id="pgnBox">
    <div><p id="showPgn" style="font-size: 20px;">PGN:</p></div>
    <button onclick="saveTextAsFile()">Save Pgn to File</button>
</div>
<div id="timerBox">
    <div><span id="time">00:00</span></div>
    <br>
    <br>
    <label style="font-size: 25px">Status:</label>
    <div style="font-size: 30px" id="status"></div>
</div>
<script type="text/javascript" src="clientlib/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"
        integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz"
        crossorigin="anonymous"></script>
<script type="text/javascript">

    var board = null;
    var game = new Chess();
    var $status = $('#status')
    var $pgn = $('#showPgn')
    var whiteSquareGrey = '#a9a9a9'
    var blackSquareGrey = '#696969'
    var alertStatus;
    var interval;
    var moveNo=0;
    var display = document.querySelector('#time');
    startCount()

    function removeGreySquares() {
        $('#myBoard .square-55d63').css('background', '')
    }

    function promotePiece(piece) {
        var promMove
        stopCount();
        var userTime = timer;
        console.log("timer on prom" + userTime)
        document.getElementById("white_promotion_pieces").style.visibility = "hidden";
        document.getElementById("black_promotion_pieces").style.visibility = "hidden";
        var checkPieceExist = "" + position_to;
        if (game.get(checkPieceExist) === null) {
            promMove = "" + position_to + "=" + piece;
        } else {
            promMove = "" + position_from.charAt(0) + "x" + position_to + "=" + piece;
        }
        var move = game.move(promMove)
        board.position(game.fen())
        sendUserMove(move, userTime)
        updateStatus()
        window.setTimeout(makeAiMove, 250)
    }


    function stopTimer() {
        clearInterval(interval);
    }

    function startTimer(duration, display) {
        var timer = duration, minutes, seconds;
        interval = setInterval(function () {
            minutes = parseInt(timer / 60, 10)
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;
            if (minutes === "00" && seconds === "00") {
                alert('Time up and Ai won the Match');
                statusUpdate('2');
                stopTimer();
            }

            if (--timer < 0) {
                timer = duration;
            }
        }, 1000);
    }

    function saveTextAsFile()
    {
        var result='';
        if(statusCalled=true){
            if(winner==='1'){
                result=' 1-0';
            }
            else if(winner==='2'){
                result=' 0-1';
            }
            else if(winner==='3'){
                result=' 1/2-1/2';
            }
        }
        var pgn=game.pgn();
        var textToSave = pgn+result;
        var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
        var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
        var fileNameToSaveAs = gameId+'.pgn';

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        downloadLink.href = textToSaveAsURL;
        downloadLink.onclick = destroyClickedElement;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);

        downloadLink.click();
    }
    function destroyClickedElement(event)
    {
        document.body.removeChild(event.target);
    }

    function statusUpdate(sts) {
        var gamePgn = game.pgn()
        if (moveNo >= 1) {
            moveNo++
            if (statusCalled === false) {
                $.ajax({
                    url: x + "/gamestatus",
                    type: 'POST',
                    data: {
                        "gameStatus": sts,
                        "gamePgn": gamePgn,
                        "gameId": gameId,
                        "moveNo": moveNo
                    },
                    success: function () {

                        console.log('draw ajax success!!');
                    },
                    error: function (jqXHR, exception) {
                        console.log('draw ajax Error occured!!');
                    }

                });
                if (sts === '3') {
                    alert('Match Draw');
                    stopTimer();
                }
                statusCalled = true;
                winner=sts;
                console.log("winner"+winner)
            }
        }

    }

    function greySquare(square) {
        if(!statusCalled){
            var $square = $('#myBoard .square-' + square)

            var background = whiteSquareGrey
            if ($square.hasClass('black-3c85d')) {
                background = blackSquareGrey
            }

            $square.css('background', background)
        }
    }

    function onDragStart(source, piece, position, orientation) {

        if (game.game_over() || statusCalled===true) {
            return false
        } else if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false

        }

    }

    function onDrop(source, target, piece, newPos, oldPos, orientation) {

        removeGreySquares()
        position_to = target;
        position_from = source;

        if (piece === 'wP' || piece === 'bP') {

            game.moves({square: source})
            var posMoves = game.moves({verbose: true})
            if (movePossible(posMoves, source, target)) {
                if (target.charAt(1) == 1 && source.charAt(1) == 2 || target.charAt(1) == 8 && source.charAt(1) == 7) {
                    if (orientation === 'white') {
                        if (game.turn() === 'w' && target.charAt(1) == 8) {
                            document.getElementById("white_promotion_pieces").style.visibility = "visible";
                        } else if (game.turn() === 'b' && target.charAt(1) == 1) {
                            document.getElementById("black_promotion_pieces").style.visibility = "visible";
                        }
                    } else if (orientation === 'black') {
                        if (game.turn() === 'w' && target.charAt(1) == 1) {
                            document.getElementById("white_promotion_pieces").style.visibility = "visible";
                        } else if (game.turn() === 'b' && target.charAt(1) == 8) {
                            document.getElementById("black_promotion_pieces").style.visibility = "visible";
                        }

                    }
                }
            }
        }

        // see if the move is legal
        var move = game.move({
            from: source,
            to: target,
        })

        // illegal move
        if (move === null) return 'snapback'

        var x = window.location.origin;
        stopCount()
        var userTime = timer;
        sendUserMove(move, userTime)
        updateStatus()
        stopTimer()
        window.setTimeout(makeAiMove, 250)
    }


    function movePossible(posMoves, source, target) {
        for (var i = 0; i < posMoves.length; i++) {
            if (posMoves[i].from === source && posMoves[i].to === target) {
                return true;
            }
        }
        return false;
    }

    function sendUserMove(move, userTime) {
        moveNo++;
        $.ajax({
            url: x + "/usermoves",
            type: 'POST',
            data: {"userMove": move.san, "timeTaken": userTime,"gameId":gameId,"moveNo":moveNo},
            async: false,
            success: function () {
                console.log('ajax success!!');
            },
            error: function (jqXHR, exception) {
                console.log('Error occured!!');
            }
        });
    }

    function onMouseoverSquare(square, piece) {
        // get list of possible moves for this square
        var moves = game.moves({
            square: square,
            verbose: true
        })

        // exit if there are no moves available for this square
        if (moves.length === 0) return

        // highlight the square they moused over
        greySquare(square)

        // highlight the possible squares for this piece
        for (var i = 0; i < moves.length; i++) {
            greySquare(moves[i].to)
        }
    }

    function onMouseoutSquare(square, piece) {
        removeGreySquares()
    }


    function onSnapEnd() {
        board.position(game.fen())
    }

    function makeAiMove() {
        callAIToPlay()
        stopCount()
        updateStatus()
        startCount()
    }

    function callAIToPlay() {
        moveNo++;
        var respMove = '';
        var x = window.location.origin;
        console.log("Inside ai Player");
        $.ajax({
            url: x + "/aiMove",
            type: 'POST',
            async: false,
            data:{"gameId":gameId , "moveNo":moveNo},
            success: function (response) {
                respMove = response.aiMove
            }
        });
        //if(!isCastling(respMove)){
        var aiMove = game.move(respMove, {sloppy: true})
        //var move=""+aiMove.from+"-"+aiMove.to;
        board.position(game.fen())
        //}
    }

    function updateStatus() {
        var status = ''
        var moveColor = 'White'
        if (game.turn() === 'b') {
            moveColor = 'Black'
        }

        // checkmate?
        if (game.in_checkmate()) {
            status = 'Game over, ' + moveColor + ' is in checkmate.'
            if (moveColor === 'White' && statusCalled === '0') {
                alert('Black won the Match');
                statusUpdate('2')
            }
            if (moveColor === 'Black' && statusCalled === '0') {
                alert('White won the Match');
                statusUpdate('1')
            }
        }

        // draw?
        else if (game.in_draw()) {
            status = 'Game over, drawn position'
            statusUpdate('3')
        }

        // game still on
        else {
            status = moveColor + ' to move'

            // check?
            if (game.in_check()) {
                status += ', ' + moveColor + ' is in check'
            }
        }

        $status.html(status)
        $pgn.html("PGN: " + game.pgn())
    }

    function onMoveEnd(oldPos, newPos) {
        var seconds=0;
        if(difficulty==='10'){
            seconds=90;
        }
        else if(difficulty==='100'){
            seconds=60;
        }
        else if(difficulty==='200'){
            seconds=30;
        }
        console.log("seconds"+seconds);
        startTimer(seconds-1, display);
    }

    var config = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onMoveEnd: onMoveEnd,
        onSnapEnd: onSnapEnd
    }
    board = Chessboard('myBoard', config)
    updateStatus()


</script>
<br><br>
<form action="/homepage" method="post" align="center">
    <input type="submit" onclick="statusUpdate('3')" value="Go Back to Home Page"/>
</form>
</body>
</html>
