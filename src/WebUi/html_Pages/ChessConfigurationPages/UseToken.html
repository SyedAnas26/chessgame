<!DOCTYPE unspecified PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <link rel="icon" href="https://lichesspro.com/favicon.png">
    <script type="text/javascript" src="../../clientlib/jquery.min-3.5.js"></script>
    <script type="text/javascript" src="../../clientlib/jquery-ui.min.js"></script>
    <title>Waiting</title>
    <script type="text/javascript">
        var x = window.location.origin;
        var baseTime;
        var playerColor;
        var uniqueId;
        window.onload = function () {
            $.ajax({
                url: x + "/getUserId",
                type: 'POST',
                success: function (response) {
                    var userId = response.user_id;
                    var userName = response.user_name;
                    uniqueId = response.unique_id;
                    if (userId === 'null') {
                        alert(' Login First ! ');
                        location = '/loginpage';
                    }
                    document.getElementById("goToHome").action = "/homepage/" + uniqueId;
                }
            });
        }


        function joinGame() {
            var token = $('#token').val();
            $.ajax({
                url: x + "/joinGame",
                type: 'POST',
                data: {"tokenId": token, "uniqueId": uniqueId},
                success: function (response) {
                    if (response.invalid === 'true') {
                        alert("The token is invalid")
                    } else {
                        if (uniqueId === response.createdUser) {
                            playerColor = response.createdByPlayAs;
                        } else if (response.createdByPlayAs === 'w') {
                            playerColor = 'b';
                        } else if (response.createdByPlayAs === 'b') {
                            playerColor = 'w';
                        }
                        if (response.challengeType === '1') {
                            baseTime = 15 * 60;
                            extratime = 0;
                        } else if (response.challengeType === '2') {
                            baseTime = 0;
                            extratime = 0;
                        } else if (response.challengeType === '3') {
                            baseTime = 2 * 60;
                            extratime = 10;
                        } else if (response.challengeType === '4') {
                            baseTime = 10 * 60;
                            extratime = 30;
                        } else if (response.challengeType.startsWith("5")) {
                            baseTime = response.challengeType.split('&')[1];
                            extratime = response.challengeType.split('&')[2];
                        }
                        localStorage["baseTime"]=baseTime;
                        localStorage["extraTime"]=extratime;
                        localStorage["playerColor"]=playerColor;
                        location = "/vs?mode=multi&id=" + uniqueId + "&gameid=" + response.gameId + "&token=" + token;
                    }
                }
            });
        }
    </script>
</head>
<body>
<div align="center" style="margin-top:250px">
    <h3>Enter the token to join a Game</h3>
    <br>
    <br><label style="font-size: 30px" for="token">Enter the Challenge Token: </label>
    <input type="text" id="token" name="token" style="font-size: 30px"/>
    <input type="button" style="font-size: 30px;" value="Join" onclick="joinGame()">
    <br>
    <br>
    <form id="goToHome" method="post" align="center">
        <input type="submit" style="font-size:16px;" id="home" onclick="askForDraw('leave')"
               value="Go Back to Home Page"/>
    </form>
</div>

</body>
</html>