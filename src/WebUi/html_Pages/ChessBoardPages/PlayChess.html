<!doctype html>
<html id="html">
<head>
    <link rel="icon" href="https://lichesspro.com/favicon.png">
    <link rel="stylesheet" href="/clientlib/ChessBoard/ChessCss.css">
    <style type="text/css">
        html {
            background-image: linear-gradient(rgba(255, 255, 255, .3), rgba(255, 255, 255, .3)), url('/img/chesspieces/wikipedia/background.jpg');
            position: static;
            height: 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
        }
    </style>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <link rel="stylesheet" href="/clientlib/cm-chessboard/cm-chessboard.css">
    <script type="text/javascript" src="/clientlib/jquery.min-3.5.js"></script>
    <script type="text/javascript" src="/clientlib/jquery-ui.min.js"></script>
    <script type="module">



    </script>
</head>
<body>
<audio id="moveSound">
    <source src="Sound/move.wav"/>
</audio>
<audio id="blackMoveSound">
    <source src="Sound/blackMove.wav"/>
</audio>
<audio id="wrongMove">
    <source src="Sound/wrongMove.mp3"/>
</audio>
<audio id="win">
    <source src="Sound/win.wav"/>
</audio>
<audio id="lose">
    <source src="Sound/lose.mp3"/>
</audio>
<audio id="captureSound">
    <source src="Sound/captureSound.mp3"/>
</audio>

<div id="pgnBox">
    <span class="spanClass" style="margin-left: 80px; font-size:30px;">Eval Score</span><br>
    <span class="spanClass" style="font-size: 22px;">Score: <span style="font-size: 22px;" id="Score"></span></span>
    <div id="showPgn">
        <h3 class="spanClass" style="margin-left:55px;">PGN:</h3>
        <ol id="whiteMove">
        </ol>
        <ul id="blackMove">
        </ul>
    </div>
    <br>
    <button onclick="saveTextAsFile()" style="font-size:16px;">Save Pgn to File</button>
    <br>
    <br>
    <div class="center-con">
        <div class="round">
            <div class="speaker">
                <div id="mute" class="mute"></div>
                <span></span>
            </div>
        </div>
    </div>
    <img src="img/chesspieces/wikipedia/reverse.png" id="reverse" style="margin-left:30px;width: 60px;height: 40px;"
         onclick="bgReverse()">
</div>
<div id="GameBox">
    <div id="white_promotion_pieces" style="padding-left: 50px;">
        <img src="img/chesspieces/wikipedia/wQ.png" id="wqueen" data-piece="wQ" style="width:62px;height:62px;"
             onclick="promotePiece('Q')">
        <img src="img/chesspieces/wikipedia/wN.png" id="wknight" data-piece="wN" style="width:62px;height:62px;"
             onclick="promotePiece('N')">
        <img src="img/chesspieces/wikipedia/wB.png" id="wbishop" data-piece="wB" style="width:62px;height:62px;"
             onclick="promotePiece('B')">
        <img src="img/chesspieces/wikipedia/wR.png" id="wrook" data-piece="wR" style="width:62px;height:62px;"
             onclick="promotePiece('R')">
    </div>
    <div id="scoreBox">
        <div id="blackColor"></div>
    </div>
    <div class="board" id="myBoard" style="width: 500px;height: 500px;"></div>
    <div id="black_promotion_pieces" style="padding-left: 50px;">
        <img src="img/chesspieces/wikipedia/bQ.png" id="bqueen" data-piece="bQ" style="width:62px;height:62px;"
             onclick="promotePiece('Q')">
        <img src="img/chesspieces/wikipedia/bN.png" id="bknight" data-piece="bN" style="width:62px;height:62px;"
             onclick="promotePiece('N')">
        <img src="img/chesspieces/wikipedia/bB.png" id="bbishop" data-piece="bB" style="width:62px;height:62px;"
             onclick="promotePiece('B')">
        <img src="img/chesspieces/wikipedia/bR.png" id="brook" data-piece="bR" style="width:62px;height:62px;"
             onclick="promotePiece('R')">
    </div>
    <input type="button" style="margin-left: 205px; font-size:16px;" onclick="askForDraw('ask')" value="Claim Draw"
           cellpadding="0" cellspacing="0"/>
    <br>
    <br>
    <form id="goToHome" method="post" align="center">
        <input type="submit" style="font-size:16px;" id="home" onclick="askForDraw('leave')"
               value="Go Back to Home Page"/>
    </form>
</div>

<div id="timerBox">
    <div id="board1" style="width: 200px;height: 200px;"></div>
    <br>
    <br>
    <div><span class="time" id="player2Time">00:00</span>&nbsp&nbsp&nbsp<span class="spanClass"
                                                                              style="font-size: 30px;color: #00E3FF">Opponent Time </span>
    </div>
    <br>
    <br>
    <br>
    <div><span class="time" id="player1Time">00:00</span>&nbsp&nbsp&nbsp<span class="spanClass"
                                                                              style="font-size: 30px; color: #00E3FF">Your Time </span>
    </div>
    <br>
    <br>
    <label class="spanClass" style="font-size: 25px; color: #00E3FF">Status:</label>
    <div style="font-size: 35px; color: #FF2432" id="status"></div>
</div>
<script src="/clientlib/ChessBoard/chessboard-1.0.0.min.js"></script>
<script src="/clientlib/ChessBoard/chess.js"></script>
<script type="module">
    var $status = $('#status')
    var whiteSquareGrey = '#a9a9a9'
    var blackSquareGrey = '#696969'
    var alertStatus = null;
    var interval;
    var moveNo = 0;
    var baseTime;
    var player2Timer = document.querySelector('#player2Time');
    var player1Timer = document.querySelector('#player1Time');
    var mode;
    let chessboard = null;
    var GameStatus = "waiting";
    var playerColor = localStorage["playerColor"];
    var statusCalled = false;
    var uniqueidServer;
    var alterStatus = null;
    var c = 0;
    var aiMove;
    var timer = 0;
    var t;
    var timer_is_on = 0;
    var x = window.location.origin;
    var position_to = '';
    var position_from = '';
    var difficulty;
    var gameId;
    var winner;
    var changedBg = 0;
    var extraTime;
    var notWrong;
    var player2CurrenSeconds;
    var player1CurrenSeconds;
    var uniqueId;
    var gamePgnSoFar;
    var alertStatus;
    var winTeam;
    var player2Score;
    var Score;
    var mute = false;
    var player1turn;
    const chess = new Chess()
    var boardFen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR';
    var webSocket;
    let board1 = null;
    var webSocketConnection = "notConnected";
    var url = location.href;
    var ws = x.replace('https://', 'wss://').replace('http://', 'ws://');
    gameId = url.split('&gameid=')[1].split('&')[0];
    uniqueId = url.split('id=')[1].split('&')[0];
    var webSocketUrl = ws + '/socket/game/' + gameId + '/' + uniqueId;
    webSocket = new WebSocket(webSocketUrl);
    var backgroundWorker = undefined;
    if (typeof (Worker) !== "undefined") {
        if (typeof (backgroundWorker) == "undefined") {
            backgroundWorker = new Worker('/clientlib/backgroundWorker.js');
        }
    } else {
        alert("Web Worker Not Supported Please Inform to the Team about ur webBrowser!")
    }

    $.ajax({
        url: x + "/getUserId",
        type: 'POST',
        success: function (response) {
            if (response.user_id === 'null') {
                alert(' Login First !');
                location = '/loginpage';
            }
            uniqueidServer = response.unique_id;
            if (uniqueId !== uniqueidServer) {
                console.log("uniqueId = "+uniqueId+"server "+uniqueidServer)
                alert('Invalid Acess!');
                location = "/homepage/" + uniqueidServer;
            }
            console.log("uni S " + uniqueidServer)
            console.log('difficulty ajax success!!');
        }
    });
    window.onload = function () {

        var url = location.href;
        mode = url.split('mode=')[1].split('&')[0];
        if (mode === "computer") {
            difficulty = localStorage["skillLevel"];
            GameStatus = "starts";
        }
        extraTime = parseInt(localStorage["extraTime"]);
        baseTime = parseInt(localStorage["baseTime"]);
        console.log("extraTime " + extraTime)
        console.log("gameId " + gameId)
        console.log("skillLevel " + difficulty)
        console.log("playerColor  " + playerColor)
        console.log("unique " + uniqueId)
        console.log("baseTime " + baseTime)
        document.getElementById("goToHome").action = "/homepage/" + uniqueId;
        player2CurrenSeconds = baseTime;
        player1CurrenSeconds = baseTime;
        webSocketConnection = "connected";
        $.ajax({
            url: x + "/getGamePosition",
            type: 'POST',
            data: {"gameId": gameId, "uniqueId": uniqueId},
            success: function (response) {
                console.log(response);
                if (response !== null) {
                    gamePgnSoFar = response.gamePosition;
                    setPositions(gamePgnSoFar);
                }
            }
        })

        if (playerColor === 'b') {
            chessboard.setOrientation('b')
            if (mode === 'computer') {
                makeAiMove();
            }
            document.getElementById("scoreBox").style.transform = "rotate(180deg)";
        }
    }


    import {
        INPUT_EVENT_TYPE,
        MOVE_INPUT_MODE,
        MARKER_TYPE,
        COLOR,
        Chessboard
    } from "/clientlib/cm-chessboard/Chessboard.js"

    function inputHandler(event) {
        console.log("event", event)
        if (event.type === INPUT_EVENT_TYPE.moveStart) {
            chessboard.setPosition(chess.fen());
            removeGreySquares();
            highlightLegalMoves(event.square);
        }
        if (event.type === INPUT_EVENT_TYPE.moveDone) {
            removeGreySquares();
            position_to = event.squareTo;
            position_from = event.squareFrom;
            const move = {from: event.squareFrom, to: event.squareTo}
            const result = chess.move(move)
            if (result) {
                playerMoved(event,result);
            } else {
                if (!checkPromotionMove(event)) {
                    if (event.squareFrom !== event.squareTo) {
                        wrongMoveSound();
                    }
                }
            }
            return result
        } else {
            return true
        }
    }

    chessboard = new Chessboard(document.getElementById("myBoard"), {
        position: chess.fen(),
        sprite: {url: "/img/chesspieces/wikipedia/chessboard-sprite.svg"},
        moveInputMode: MOVE_INPUT_MODE.dragPiece
    })
    if (playerColor === 'w') {
        chessboard.enableMoveInput(inputHandler, COLOR.white)
    }


    board1 = new Chessboard(document.getElementById("board1"),
        {
            position: "start",
            sprite: {url: "/img/chesspieces/wikipedia/chessboard-sprite.svg"},
            responsive: true
        });


    function playerMoved(event,move) {

        event.chessboard.disableMoveInput()
        stopTimer()
        updateStatus()
        if (mode === 'computer') {
            if (moveNo === 0) {
                startTimer(player2CurrenSeconds, player2Timer);
            } else {
                startTimer(player2CurrenSeconds + extraTime, player2Timer);
            }
        } else if (mode === 'multi') {
            webSocket.send(move.san);
            if(!statusCalled){
                if (moveNo === 0) {
                    setTimeout(() => {
                        startTimer(player2CurrenSeconds, player2Timer);
                    }, 800);
                } else {
                    setTimeout(() => {
                        startTimer(player2CurrenSeconds + extraTime, player2Timer);
                    }, 700);
                }
            }
        }
        var userTime = player1CurrenSeconds;
        sendUserMove(move, userTime)
        playMoveSound(move);
        var fen = chess.fen();
        boardFen = chessboard.getPosition();
        if (!statusCalled) {
            backgroundWorker.postMessage({'do': 'analyse', 'fen': fen});
        }
        player1turn = false;
        if(mode=='computer'){
            window.setTimeout(makeAiMove, 1000);
        }
    }


    function checkPromotionMove(event) {
        chess.moves({square: event.squareFrom})
        var posMoves = chess.moves({verbose: true})
        if (movePossible(posMoves, position_from, position_to)) {
            if (position_to.charAt(1) == 1 && position_from.charAt(1) == 2 || position_to.charAt(1) == 8 && position_from.charAt(1) == 7) {
                // if (orientation === 'white') {
                if (chess.turn() === 'w' && position_to.charAt(1) == 8) {
                    document.getElementById("white_promotion_pieces").style.visibility = "visible";
                    return true;
                } else if (chess.turn() === 'b' && position_to.charAt(1) == 1) {
                    document.getElementById("black_promotion_pieces").style.visibility = "visible";
                    return true;
                }
            }
        }
        return false;
    }

    function setPositions(gamePgnSoFar) {

        var result = '';
        chess.load_pgn(gamePgnSoFar);
        chessboard.setPosition(chess.fen());
        var arr = gamePgnSoFar.split(/\d+. |\s+/g);
        var filtered = arr.filter(function (el) {
            return el !== "";
        });
        console.log(arr[arr.length - 1])
        if (arr[arr.length - 1] === "0-1") {
            result = " 0-1";
            statusCalled = true;
            alert("Match Over Player 2 Won (Black)");
        } else if (arr[arr.length - 1] === "1-0") {
            result = " 1-0";
            statusCalled = true;
            alert("Match Over Player 1 Won (White)");
        } else if (arr[arr.length - 1] === "1/2-1/2") {
            result = " 1/2-1/2";
            statusCalled = true;
            alert("Match Over Drawn");
        }
        moveNo = filtered.length;
        if (moveNo > 1) {
            player2CurrenSeconds = parseInt(window.localStorage.getItem("" + gameId + "Player2")) - 2;
            player1CurrenSeconds = parseInt(window.localStorage.getItem("" + gameId + "Player1")) - 2;
        }
        console.log(extraTime)
        var secondsFromStorage;
        var display;
        GameStatus = "starts";
        if (chess.turn() !== playerColor) {
            secondsFromStorage = player2CurrenSeconds;
            display = player2Timer;
        } else {
            secondsFromStorage = player1CurrenSeconds;
            display = player1Timer;
        }
        if (!statusCalled) {
            stopTimer();
            console.log('sec From storage ' + secondsFromStorage)
            startTimer(secondsFromStorage, display);
            if(chess.turn()===playerColor){
                if(playerColor==='w'){
                    chessboard.enableMoveInput(inputHandler, COLOR.white);
                }
                else if(playerColor==='b'){
                    chessboard.enableMoveInput(inputHandler, COLOR.black);
                }
            }
        }
        addPgnDisplayToUi(gamePgnSoFar);
    }

    function removeGreySquares() {
        chessboard.removeMarkers(null, null);
        // chessboard.removeMarkers(null, MARKER_TYPE.capture);

    }

    window.promotePiece=function (piece) {
        var promMove
        var userTime = player1CurrenSeconds;
        console.log("timer on prom" + userTime)
        document.getElementById("white_promotion_pieces").style.visibility = "hidden";
        document.getElementById("black_promotion_pieces").style.visibility = "hidden";
        var checkPieceExist = "" + position_to;
        if (chess.get(checkPieceExist) === null) {
            promMove = "" + position_to + "=" + piece;
        } else {
            promMove = "" + position_from.charAt(0) + "x" + position_to + "=" + piece;
        }
        var move = chess.move(promMove)
        chessboard.setPosition(chess.fen())
        sendUserMove(move, userTime)
        updateStatus()
        startTimer(player2CurrenSeconds, player2Timer);
        if (mode === 'computer') {
            window.setTimeout(makeAiMove, 250)
        } else if (mode === 'multi') {
            webSocket.send(move.san);
        }
    }

    document.body.addEventListener("click", function (evt) {
        document.getElementById("board1").style.visibility = "hidden";
    });

    window.askForDraw=function(event) {
        if (!statusCalled) {
            if (event === 'ask') {
                if (mode === 'computer') {
                    sendStatus('3');
                } else {
                    webSocket.send("draw");
                    alert("Draw Request Sent ! Waiting for Opponent response");
                }
            } else {
                if (mode === 'computer') {
                    sendStatus('3');
                } else {
                    webSocket.send('left');
                }
            }
        }
    }

    function stopTimer() {
        clearInterval(interval);
    }

    function playMoveSound(move) {
        if (mute === false) {
            var san = move.san;
            for (var i = 0; i < san.length; i++) {
                if (san.charAt(i) === 'x') {
                    document.getElementById("captureSound").play();
                    return;
                }
            }
            if (chess.turn() === 'b') {
                document.getElementById("moveSound").play();
            } else {
                document.getElementById('blackMoveSound').play();
            }
        }
    }

    function wrongMoveSound() {
        if (!mute) {
            document.getElementById("wrongMove").play();
        }
    }

    function startTimer(duration, display) {
        var timer = duration, minutes, seconds;
        if(baseTime!==0){
            interval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                if (display === player2Timer) {
                    player2CurrenSeconds = (minutes * 60) + seconds;
                } else if (display === player1Timer) {
                    player1CurrenSeconds = (minutes * 60) + seconds;
                }
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                display.textContent = minutes + ":" + seconds;
                window.localStorage.setItem("" + gameId + "Player2", player2CurrenSeconds);
                window.localStorage.setItem("" + gameId + "Player1", player1CurrenSeconds);
                if (baseTime !== 0 && minutes === "00" && seconds === "00") {
                    if (display === player1Timer) {
                        alert('Time Up Opponent Won');
                        if (playerColor === 'b') {
                            sendStatus('1');
                        } else {
                            sendStatus('2');
                        }
                    } else {
                        alert('Opponent Time Up You Won');
                        if (playerColor === 'b') {
                            sendStatus('2');
                        } else {
                            sendStatus('1');
                        }
                    }
                }
                if (--timer < 0) {
                    timer = duration;
                }
            }, 1000);
        }
    }

    $('.speaker').click(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).toggleClass('on');
        mute = (mute == false) ? true : false;
    });

    function saveTextAsFile() {
        var result = '';
        if (statusCalled === true) {
            if (winner === '1') {
                result = ' 1-0';
            } else if (winner === '2') {
                result = ' 0-1';
            } else if (winner === '3') {
                result = ' 1/2-1/2';
            }
        }
        var pgn = chess.pgn();
        var textToSave = pgn + result;
        var textToSaveAsBlob = new Blob([textToSave], {type: "text/plain"});
        var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
        var fileNameToSaveAs = gameId + '.pgn';
        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        downloadLink.href = textToSaveAsURL;
        downloadLink.onclick = destroyClickedElement;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
    }

    function destroyClickedElement(event) {
        document.body.removeChild(event.target);
    }

    function sendStatus(sts) {
        var gamePgn = chess.pgn()
        if (moveNo >= 1) {
            moveNo++
            if (statusCalled === false && gamePgn !== null) {
                $.ajax({
                    url: x + "/gamestatus",
                    type: 'POST',
                    data: {
                        "gameStatus": sts,
                        "gamePgn": gamePgn,
                        "gameId": gameId,
                        "moveNo": moveNo,
                        "uniqueId": uniqueId
                    },
                    success: function () {

                        console.log('draw ajax success!!');
                    },
                    error: function (jqXHR, exception) {
                        console.log('draw ajax Error occured!!');
                    }

                });
                statusCalled = true;
                chessboard.disableMoveInput();
                winner = sts;
                stopTimer();
                if (sts === '1' && playerColor === 'w') {
                    if (!mute) {
                        document.getElementById("win").play();
                        document.getElementById("win").onended = function () {
                            alert("You Won the Match");
                        };
                    }
                } else if (sts === '2' && playerColor === 'b') {
                    if (!mute) {
                        document.getElementById("win").play();
                        document.getElementById("win").onended = function () {
                            alert("You Won the Match");
                        };
                    } else {
                        alert("You Won the Match")
                    }
                } else if(sts === '2' && playerColor === 'w' || sts === '1' && playerColor === 'b') {
                    if (!mute) {
                        document.getElementById("lose").play();
                        document.getElementById("lose").onended = function () {
                            alert("Opponent Won the Match");
                        };
                    } else {
                        alert("Opponent Won the Match");
                    }
                }
                if (sts === '3') {
                    alert('Match Draw');
                    winTeam = 'Draw';
                }
                stopTimer();
                console.log("winner" + winner)
            }
        }

    }


    function greySquare(square) {
        if (!statusCalled) {
            if(square.flags==='c'){
                chessboard.addMarker(square.to, MARKER_TYPE.capture);
            }
            chessboard.addMarker(square.to, MARKER_TYPE.dot);
        }
    }

    webSocket.onmessage = function (event) {
        var msg = event.data;
        var reply;
        console.log('onmessage::' + msg);
        if (msg === 'start' && GameStatus !== "starts") {
            GameStatus = "starts";
            if (playerColor == 'w') {
                chessboard.enableMoveInput(inputHandler, COLOR.white)
            }
            alert(" Opponent Joined Game Starts ! ");
            webSocket.send('start');
            return;
        }
        if (msg === 'left') {
            alert("Opponent left the Match !");
            sendStatus('3');
        }
        if (msg === "ok") {
            alert("Opponent Accepted Draw Request !");
            sendStatus('3');
            return;
        } else if (msg === "no") {
            alert("Opponent Rejected ur Draw Request !")
            return;
        }
        if (msg === "draw") {
            if (confirm("Shall we draw the Match ?")) {
                sendStatus('3');
                reply = "ok";
            } else {
                reply = "no";
            }
            webSocket.send(reply);
            return;
        }
        var move = chess.move(msg, {sloppy: true});
        if (move === null) {
            return;
        }
        chessboard.setPosition(chess.fen());
        if (playerColor == 'w' && statusCalled !== true) {
            chessboard.enableMoveInput(inputHandler, COLOR.white);
        } else if (playerColor == 'b' && statusCalled !== true) {
            chessboard.enableMoveInput(inputHandler, COLOR.black);
        }
        if (!statusCalled) {
            backgroundWorker.postMessage({'do': 'analyse', 'fen': chess.fen()});
        }
        moveNo++;
        player1turn = true;
        playMoveSound(move);
        boardFen = chessboard.getPosition();
        stopTimer();
        if (moveNo <= 1) {
            startTimer((player1CurrenSeconds), player1Timer);
        } else {
            startTimer((player1CurrenSeconds + extraTime), player1Timer);
        }
        updateStatus();
    }

    function movePossible(posMoves, source, target) {
        for (var i = 0; i < posMoves.length; i++) {
            if (posMoves[i].from === source && posMoves[i].to === target) {
                return true;
            }
        }
        return false;
    }

    function sendUserMove(move, userTime) {
        moveNo++;
        var gameTillNow = chess.pgn();
        var fen = chess.fen();
        backgroundWorker.postMessage({
            'do': 'storeMove',
            'uniqueId': uniqueId,
            'fen': fen,
            'move': move.san,
            'time': userTime,
            'gameId': gameId,
            'moveNo': moveNo,
            'gamePgn': gameTillNow
        })
    }

    function highlightLegalMoves(square) {
        // get list of possible moves for this square
        var moves = chess.moves({
            square: square,
            verbose: true
        })
        // exit if there are no moves available for this square
        if (moves.length === 0) return
        // highlight the square they moused over
        var fen = chess.fen()
        console.log(fen)

        if (chessboard.getPosition() === fen.split(' ')[[0]] && chess.turn() === playerColor) {
            // highlight the possible squares for this piece
            for (var i = 0; i < moves.length; i++) {
                greySquare(moves[i])
            }
        }
    }

    function makeAiMove() {
        callAIToPlay();
        player1turn = true;
        if (moveNo === 2) {
            startTimer(player1CurrenSeconds, player1Timer);
        } else {
            var sec = player1CurrenSeconds + extraTime;
            console.log('Seconds = ' + sec)
            startTimer(sec, player1Timer);
        }
    }

    function callAIToPlay() {
        moveNo++;
        var fen = chess.fen();
        var gameTillNow = chess.pgn();
        boardFen = chessboard.getPosition();
        stopTimer();
        backgroundWorker.postMessage({'do': 'getAiMove', 'fen': fen, 'skillLevel': difficulty})
    }

    backgroundWorker.onmessage = function (response) {
        var data = response.data;
        switch (data.from) {
            case 'ai':
                aiMove = chess.move(data.aiMove, {sloppy: true})
                playMoveSound(aiMove)
                chessboard.setPosition(chess.fen())
                var fen = chess.fen();
                if (!statusCalled) {
                    backgroundWorker.postMessage({'do': 'analyse', 'fen': fen});
                }
                var gameTillNow = chess.pgn();
                updateStatus();
                if (playerColor == 'w' && statusCalled !== true) {
                    chessboard.enableMoveInput(inputHandler, COLOR.white);
                } else if (playerColor == 'b' && statusCalled !== true) {
                    chessboard.enableMoveInput(inputHandler, COLOR.black);
                }
                backgroundWorker.postMessage({
                    'do': 'storeMove',
                    'uniqueId': '0',
                    'fen': fen,
                    'move': aiMove.san,
                    'time': player2CurrenSeconds,
                    'gameId': gameId,
                    'moveNo': moveNo,
                    'gamePgn': gameTillNow
                });
                break;

            case 'storage':
                break;

            case 'analyse':
                var res = data.score;
                if (res.toString().startsWith("-")) {
                    var increase = 50 + (Math.abs(parseFloat(data.score)) / 100);
                    var set = increase + "%";
                    document.getElementById("blackColor").style.height = set;
                } else {
                    var decrease = 50 - (parseFloat(data.score) / 100);
                    if (decrease > 100) {
                        decrease = 100;
                    }
                    if (decrease < 0) {
                        decrease = 0;
                    }
                    var set = decrease + "%";
                    document.getElementById("blackColor").style.height = set;
                }
                Score = parseFloat(data.score / 100);
                document.getElementById("Score").innerHTML = Score;
        }

    }

    window.bgReverse=function () {
        if (changedBg >= 2) {
            changedBg = 0;
        } else {
            changedBg++;
        }
        if (changedBg == 1) {
            document.getElementById("html").style.background = "none";
            document.getElementById("scoreBox").style.backgroundColor = "#C0C7CE";
            changedBg = true;
        } else if (changedBg == 0) {
            document.getElementById("html").style.backgroundImage = "linear-gradient(rgba(255, 255, 255, .3), rgba(255, 255, 255, .3)), url('/img/chesspieces/wikipedia/background.jpg')";
            document.getElementById("scoreBox").style.backgroundColor = "white";
            document.getElementById("html").style.position = "static";
            document.getElementById("html").style.backgroundPosition = "center";
            document.getElementById("html").style.backgroundRepeat = "no-repeat";
            document.getElementById("html").style.backgroundSize = "cover";
            document.getElementById("html").style.backgroundAttachment = "fixed";
        } else if (changedBg == 2) {
            document.getElementById("html").style.backgroundImage = "linear-gradient(rgba(255, 255, 255, .3), rgba(255, 255, 255, .3)), url('/img/chesspieces/wikipedia/watchpg.jpg')";
            document.getElementById("scoreBox").style.backgroundColor = "white";
            document.getElementById("html").style.position = "static";
            document.getElementById("html").style.backgroundPosition = "center";
            document.getElementById("html").style.backgroundRepeat = "no-repeat";
            document.getElementById("html").style.backgroundSize = "cover";
            document.getElementById("html").style.backgroundAttachment = "fixed";
        }

    }

    function updateStatus() {
        var status = ''
        var moveColor = 'White'
        if (chess.turn() === 'b') {
            moveColor = 'Black'
        }

        // checkmate?
        if (chess.in_checkmate()) {
            status = 'Game over, ' + moveColor + ' is in checkmate.'
            if (moveColor === 'White' && statusCalled === false) {
                alertStatus = 'Black won the Match';
                sendStatus('2')
            }
            if (moveColor === 'Black' && statusCalled === false) {
                alertStatus = 'White won the Match';
                sendStatus('1')
            }
        }

        // draw?
        else if (chess.in_draw()) {
            status = 'Game over, drawn position'
            stopTimer();
            sendStatus('3')
        }

        // game still on
        else {
            status = moveColor + ' to move'

            // check?
            if (chess.in_check()) {
                status += ', ' + moveColor + ' is in check'
            }
        }

        $status.html(status)
        addPgnDisplayToUi(chess.pgn());
    }

    function removePgnListChilds() {
        const deleteWhitePgnMoves = document.getElementById("whiteMove");
        while (deleteWhitePgnMoves.lastElementChild) {
            deleteWhitePgnMoves.removeChild(deleteWhitePgnMoves.lastElementChild);
        }
        const deleteBlackPgnMoves = document.getElementById("blackMove");
        while (deleteBlackPgnMoves.lastElementChild) {
            deleteBlackPgnMoves.removeChild(deleteBlackPgnMoves.lastElementChild);
        }
    }

    function addPgnDisplayToUi(gamePgn) {
        removePgnListChilds();
        if (gamePgn !== 'null') {
            var arr = gamePgn.split(/\d+. |\s+/g);
            var movesMade = arr.filter(function (el) {
                return el != "";
            });
            for (var i = 0; i < movesMade.length; i++) {
                if (i === 0 || i % 2 === 0) {
                    showPgnInDisplay("whiteMove", movesMade, i, Score);
                } else if (i > 0) {
                    showPgnInDisplay("blackMove", movesMade, i, Score);
                }
            }
        }
    }

    function showPgnInDisplay(elementId, movesMade, i, sc) {
        var store;
        var score;
        localStorage.setItem("" + i, sc);
        var player2ScoreHere;
        var player1ScoreHere;
        var onClickIsCalled = false;
        var node = document.createElement("LI");
        var a = document.createElement("a");
        node.onmouseover = function () {
            store = i;
            player2ScoreHere = player2Score;
            player1ScoreHere = Score;
            var length = movesMade.length;
            if (movesMade[movesMade.length - 1] === "1/2-1/2" || movesMade[movesMade.length - 1] === "1-0" || movesMade[movesMade.length - 1] === "0-1") {
                length = length - 1;
            }
            var game = new Chess();
            game.load_pgn(chess.pgn());
            var loopfor = ((length) - store) - 1;
            for (var j = 0; j < loopfor; j++) {
                game.undo();
            }
            board1.setPosition(game.fen())
            document.getElementById("board1").style.visibility = "visible";
        }

        node.onclick = function (event) {
            $('li').removeClass('active');
            $(this).addClass('active');
            onClickIsCalled = true;
            event.preventDefault()
            score = localStorage.getItem("" + i);
            var length = movesMade.length;
            if (movesMade[movesMade.length - 1] === "1/2-1/2" || movesMade[movesMade.length - 1] === "1-0" || movesMade[movesMade.length - 1] === "0-1") {
                length = length - 1;
            }
            var game = new Chess();
            game.load_pgn(chess.pgn());
            var loopfor = ((length) - store) - 1;
            for (var j = 0; j < loopfor; j++) {
                game.undo();
            }
            chessboard.setPosition(game.fen());
            removeGreySquares();
            backgroundWorker.postMessage({'do': 'analyse', 'fen': game.fen()});
            if (!mute) {
                document.getElementById('moveSound').play();
            }
        }
        a.textContent = "" + movesMade[i];
        a.setAttribute("href", "#");
        node.appendChild(a);
        if (i === (movesMade.length - 1)) {
            node.classList.add("active");
        }
        node.classList.add("displaySmallBoard")
        document.getElementById(elementId).appendChild(node);
    }
</script>
<br><br>
</body>
</html>
